<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>إضافة مناقصة | I.TECH</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="preload" as="style" onload="this.rel='stylesheet'">
  <noscript><link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet"></noscript>
  <link rel="stylesheet" href="./css/main.css" />
</head>
<body class="page-controll">
  <script>
    (function(){
      try {
        const t = sessionStorage.getItem('itech_token');
        if(!t){ location.href = 'controll.html'; }
      } catch { /* إذا تعطلت الجلسة سنعيد المستخدم لصفحة الدخول */
        location.href = 'controll.html';
      }
    })();
  </script>
  <header class="nav">
    <div class="brand">
      <div class="logo-circle"><img src="./assets/images/I-Tech logo.png" alt="I.TECH"/></div>
      <div class="names"><div class="ar">ايتك</div><div class="en">I.TECH</div></div>
    </div>
    <nav class="menu" aria-label="التنقل">
      <a href="index.html">الرئيسية</a>
      <a href="tenders-new.html">مناقصات العراق</a>
      <a href="tender-admin-simple.html">إضافة بسيطة</a>
      <a href="#" id="btnLogout">تسجيل الخروج</a>
    </nav>
    <button class="burger" aria-label="فتح القائمة" aria-expanded="false">☰</button>
  </header>

  <main class="container">
    <section class="card" id="adminArea">
      <h1>إضافة مناقصة جديدة</h1>
      <p>املأ الحقول ثم اضغط "نشر على GitHub" لتحديث الملف JSON ضمن الموقع مباشرة (بدون Backend). البيانات تظهر في صفحة "مناقصات العراق" فور تحديث الملف.</p>
      <div class="grid-2">
        <div>
          <div class="form">
            <label>رقم المناقصة (id)</label>
            <input id="f_id" placeholder="مثال: 2025-006"/>
            <label>العنوان</label>
            <input id="f_title"/>
            <label>الجهة</label>
            <input id="f_entity"/>
            <label>التصنيف</label>
            <select id="f_category">
              <option>حكومية</option>
              <option>شركات</option>
              <option>جامعات</option>
              <option>منظمات</option>
            </select>
            <label>المدينة</label>
            <input id="f_city"/>
            <label>رقم الإعلان</label>
            <input id="f_adNumber"/>
            <label>تاريخ النشر</label>
            <input id="f_postedDate" type="date"/>
            <label>الموعد النهائي</label>
            <input id="f_deadline" type="date"/>
            <label>الحالة</label>
            <input id="f_status" placeholder="مفتوح"/>
            <label>رابط المصدر</label>
            <input id="f_link" placeholder="#"/>
            <label>الوصف</label>
            <textarea id="f_description" rows="4"></textarea>
            <label>سعر الكراس</label>
            <input id="f_documentPrice" type="number"/>
            <label>العملة</label>
            <input id="f_currency" value="IQD"/>
            <label>مكان استلام الكراس</label>
            <input id="f_pickupLocation"/>
            <label>مكان التقديم</label>
            <input id="f_submissionPlace"/>
            <label>متطلبات التقديم (افصل بـ ;)</label>
            <textarea id="f_requirements" rows="3" placeholder="هوية الضريبة; كتاب عدم ممانعة"></textarea>
            <label>ملاحظات</label>
            <textarea id="f_notes" rows="2"></textarea>
            <label>هاتف الاتصال</label>
            <input id="f_phone"/>
            <label>البريد الإلكتروني</label>
            <input id="f_email"/>
            <div id="publishStatus" style="margin-top:15px;padding:12px;border-radius:5px;display:none;font-weight:600;"></div>

            <hr style="margin:18px 0; opacity:.3;">
            <h2 style="margin:6px 0 10px;">نشر مباشر على GitHub Pages (بدون Backend)</h2>
            <p class="muted">هذه الطريقة تُجري تعديلًا مباشرًا على الملف <strong>assets/data/tenders.json</strong> داخل مستودع GitHub عبر واجهة GitHub API. تتطلب رمز وصول شخصي (PAT) مع صلاحية <strong>contents:write</strong> لهذا المستودع. لا تشارك الرمز علنًا.</p>
            <div class="form">
              <label>GitHub Owner</label>
              <input id="gh_owner" placeholder="مثال: abubesun-hub"/>
              <label>GitHub Repo</label>
              <input id="gh_repo" placeholder="مثال: I.tech"/>
              <label>Branch</label>
              <input id="gh_branch" value="main"/>
              <label>Path داخل المستودع</label>
              <input id="gh_path" value="assets/data/tenders.json"/>
              <label>GitHub Token (PAT)</label>
              <input id="gh_token" type="password" placeholder="ghp_xxx أو fine-grained token"/>
              <div style="display:flex;align-items:center;gap:10px;margin-top:8px;">
                <label style="display:flex;align-items:center;gap:6px;">
                  <input type="checkbox" id="gh_remember_token"/>
                  حفظ الرمز محليًا على هذا المتصفح (اختياري)
                </label>
              </div>
              <div class="actions" style="margin-top:12px;">
                <button class="btn primary" id="btnPublishGithub">نشر مباشر على صفحة المناقصات (GitHub)</button>
                <button class="btn" id="btnTestConnection" style="margin-right: 10px;">اختبار الاتصال</button>
              </div>
            </div>
          </div>
        </div>
        <div>
          <h2>المناقصات المعلنة</h2>
          <div class="actions" style="margin-bottom:8px;">
            <button class="btn" id="btnRefreshList">تحديث القائمة</button>
            <button class="btn" id="btnClearTendersCache">مسح كاش المناقصات</button>
          </div>
          <div id="adminList" class="card" style="padding:12px;"></div>
        </div>
      </div>
    </section>
  </main>

  <script>
  // Ensure initialization runs whether DOMContentLoaded has fired or not
  function initAdminPage(){
    // زر خروج بسيط يمسح الـ Token
    try{
      const lo = document.getElementById('btnLogout');
      if (lo) lo.addEventListener('click', (e)=>{ e.preventDefault(); try{ sessionStorage.removeItem('itech_token'); } catch {} location.href = 'controll.html'; });
    }catch{}

    const $ = (id)=>document.getElementById(id);
    // تهيئة بسيطة
    function buildItem(){
      const reqs = ($('#f_requirements').value||'').split(';').map(s=>s.trim()).filter(Boolean);
      return {
        id: $('#f_id').value || ('TMP-' + Date.now()),
        title: $('#f_title').value,
        entity: $('#f_entity').value,
        category: $('#f_category').value,
        city: $('#f_city').value,
        adNumber: $('#f_adNumber').value,
        deadline: $('#f_deadline').value,
        postedDate: $('#f_postedDate').value,
        status: $('#f_status').value || 'مفتوح',
        link: $('#f_link').value || '#',
        description: $('#f_description').value,
        documentPrice: parseInt($('#f_documentPrice').value||'0',10),
        currency: $('#f_currency').value || 'IQD',
        pickupLocation: $('#f_pickupLocation').value,
        submissionPlace: $('#f_submissionPlace').value,
        submissionRequirements: reqs,
        notes: $('#f_notes').value,
        files: [],
        contact: { phone: $('#f_phone').value, email: $('#f_email').value }
      };
    }
    // لا حاجة لتوليد CSV/تنزيلات؛ النشر يتم عبر GitHub API مباشرة

    // ---- النشر المباشر إلى GitHub (تعديل الملف داخل المستودع) ----
    // Helpers
    function utf8ToBase64(str){
      try { return btoa(unescape(encodeURIComponent(str))); } catch(e){ return btoa(str); }
    }
    function encodePathSegments(p){
      try { return (p||'').split('/').map(encodeURIComponent).join('/'); } catch { return p; }
    }
    async function githubGetFileSha(owner, repo, branch, path, token){
      const url = `https://api.github.com/repos/${encodeURIComponent(owner)}/${encodeURIComponent(repo)}/contents/${encodePathSegments(path)}?ref=${encodeURIComponent(branch)}`;
      console.log('طلب SHA من:', url);
      
      const headers = { 
        'Accept':'application/vnd.github+json', 
        'Authorization': `Bearer ${token}`,
        'User-Agent': 'I.TECH-Admin/1.0'
      };
      
      const r = await fetch(url, { headers });
      console.log('استجابة SHA:', r.status, r.statusText);
      
      if (r.status === 404) {
        console.log('الملف غير موجود، سيتم إنشاؤه');
        return null; // file not found
      }
      
      if (!r.ok) {
        const errorText = await r.text();
        console.error('خطأ في طلب SHA:', errorText);
        throw new Error('GitHub API (get sha) failed: '+r.status + ' - ' + errorText);
      }
      
      const j = await r.json();
      console.log('SHA response:', j);
      return j && j.sha ? j.sha : null;
    }
    async function githubPutFile(owner, repo, branch, path, contentBase64, message, shaOrNull, token){
      const url = `https://api.github.com/repos/${encodeURIComponent(owner)}/${encodeURIComponent(repo)}/contents/${encodePathSegments(path)}`;
      console.log('رفع ملف إلى:', url);
      
      const body = { 
        message, 
        content: contentBase64, 
        branch 
      };
      if (shaOrNull) body.sha = shaOrNull;
      
      console.log('محتوى الطلب:', { 
        message: body.message, 
        branch: body.branch, 
        contentLength: contentBase64.length,
        hasSha: !!shaOrNull 
      });
      
      const headers = {
        'Accept': 'application/vnd.github+json', 
        'Content-Type': 'application/json', 
        'Authorization': `Bearer ${token}`,
        'User-Agent': 'I.TECH-Admin/1.0'
      };
      
      const r = await fetch(url, { 
        method: 'PUT', 
        headers, 
        body: JSON.stringify(body) 
      });
      
      console.log('استجابة الرفع:', r.status, r.statusText);
      
      if (!r.ok) {
        const errorText = await r.text();
        console.error('خطأ في رفع الملف:', errorText);
        
        // رسائل خطأ مفصلة حسب نوع المشكلة
        if (r.status === 401) {
          throw new Error('خطأ في التوثيق: GitHub Token غير صحيح أو منتهي الصلاحية. يرجى التحقق من الرمز.');
        } else if (r.status === 403) {
          throw new Error('ممنوع: لا توجد صلاحية للكتابة في هذا المستودع. تحقق من أن Token لديه صلاحية contents:write');
        } else if (r.status === 404) {
          throw new Error('المستودع غير موجود أو لا يمكن الوصول إليه. تحقق من اسم المالك والمستودع.');
        } else if (r.status === 409) {
          throw new Error('تضارب في الملف. يرجى تحديث الصفحة والمحاولة مرة أخرى.');
        } else {
          throw new Error(`GitHub API خطأ ${r.status}: ${errorText}`);
        }
      }
      
      const result = await r.json();
      console.log('نجح الرفع:', result);
      return result;
    }
    async function fetchCurrentTendersRaw(owner, repo, branch, path){
      const rawUrl = `https://raw.githubusercontent.com/${owner}/${repo}/${encodeURIComponent(branch)}/${path}`;
      console.log('جلب البيانات الحالية من:', rawUrl);
      
      const r = await fetch(rawUrl, {
        cache: 'no-store', // تجنب الكاش للحصول على أحدث نسخة
        headers: {
          'Accept': 'application/json'
        }
      });
      
      console.log('حالة جلب البيانات:', r.status);
      
      if (r.status === 404) {
        console.log('الملف غير موجود، سيبدأ بمصفوفة فارغة');
        return [];
      }
      
      if (!r.ok) {
        console.error('فشل جلب البيانات:', r.status, r.statusText);
        throw new Error('Fetch raw failed: '+r.status);
      }
      
      try { 
        const data = await r.json();
        console.log('تم جلب البيانات بنجاح، عدد العناصر:', Array.isArray(data) ? data.length : 'ليس مصفوفة');
        return Array.isArray(data) ? data : [];
      } catch (parseError) { 
        console.error('خطأ في تحليل JSON:', parseError);
        return []; 
      }
    }

    // Prefill from LocalStorage
    try {
      const owner = localStorage.getItem('itech_gh_owner'); if (owner) $('#gh_owner').value = owner;
      const repo = localStorage.getItem('itech_gh_repo'); if (repo) $('#gh_repo').value = repo;
      const branch = localStorage.getItem('itech_gh_branch'); if (branch) $('#gh_branch').value = branch;
      const path = localStorage.getItem('itech_gh_path'); if (path) $('#gh_path').value = path;
      const savedTok = localStorage.getItem('itech_gh_token'); if (savedTok) { $('#gh_token').value = savedTok; $('#gh_remember_token').checked = true; }
    } catch {}

    const elPublishGh = $('#btnPublishGithub');
    if (elPublishGh) elPublishGh.addEventListener('click', async ()=>{
      const statusEl = $('#publishStatus');
      function setStatus(msg, color){ 
        if (statusEl) { 
          statusEl.textContent = msg; 
          statusEl.style.color = color || 'var(--text-muted)';
          statusEl.style.display = 'block';
          statusEl.style.padding = '10px';
          statusEl.style.border = '1px solid ' + (color || '#ddd');
          statusEl.style.borderRadius = '5px';
          statusEl.style.backgroundColor = color === 'green' ? '#d4edda' : color === 'red' ? '#f8d7da' : '#d1ecf1';
        }
        console.log('Status:', msg); // للتشخيص
      }
      
      // التحقق من وجود البيانات المطلوبة
      const tender = buildItem();
      if (!tender.title || !tender.entity) {
        setStatus('خطأ: يرجى ملء العنوان والجهة على الأقل', 'red');
        alert('يرجى ملء العنوان والجهة على الأقل');
        return;
      }
      
      // visual feedback immediately
      setStatus('بدء عملية النشر إلى GitHub...', 'blue');
      elPublishGh.disabled = true;
      console.log('بدء عملية النشر...', tender);
      
      try {
        const owner = ($('#gh_owner').value||'').trim();
        const repo = ($('#gh_repo').value||'').trim();
        const branch = ($('#gh_branch').value||'main').trim();
        const path = ($('#gh_path').value||'assets/data/tenders.json').trim();
        const token = ($('#gh_token').value||'').trim();
        
        console.log('إعدادات GitHub:', { owner, repo, branch, path, tokenLength: token.length });
        
        if (!owner || !repo || !branch || !path || !token) { 
          setStatus('خطأ: أكمل جميع حقول GitHub وادخل الرمز (PAT)', 'red');
          alert('أكمل حقول GitHub وادخل الرمز (PAT).');
          return; 
        }

        // persist preferences
        try {
          localStorage.setItem('itech_gh_owner', owner);
          localStorage.setItem('itech_gh_repo', repo);
          localStorage.setItem('itech_gh_branch', branch);
          localStorage.setItem('itech_gh_path', path);
          const remember = $('#gh_remember_token').checked; if (remember) localStorage.setItem('itech_gh_token', token); else localStorage.removeItem('itech_gh_token');
        } catch {}

        setStatus('جلب الملف الحالي من GitHub...', 'blue');
        console.log('جلب البيانات من GitHub...');
        
        let arr = [];
        try {
          arr = await fetchCurrentTendersRaw(owner, repo, branch, path);
          console.log('البيانات الحالية:', arr);
        } catch (fetchError) {
          console.log('تعذر جلب البيانات الحالية، سيتم إنشاء ملف جديد:', fetchError);
          arr = [];
        }
        
        const item = tender;
        console.log('المناقصة الجديدة:', item);
        
        // منع تكرار id إن وجد
        const exists = Array.isArray(arr) && arr.some(x => String(x.id||'') === String(item.id||''));
        if (exists) {
          const confirmed = confirm('يوجد عنصر بنفس رقم المناقصة. متابعة واستبدال القديم؟');
          setStatus(confirmed ? 'سيتم استبدال المناقصة الموجودة...' : 'تم إلغاء العملية', confirmed ? 'orange' : 'red');
          if (!confirmed) return;
          for (let i=0;i<arr.length;i++){ if (String(arr[i].id||'') === String(item.id||'')) { arr[i] = item; break; } }
        } else {
          arr.push(item);
        }

        const newJson = JSON.stringify(arr, null, 2) + '\n';
        console.log('JSON الجديد جاهز، الحجم:', newJson.length);
        
        setStatus('الحصول على SHA للملف من GitHub...', 'blue');
        let sha = null;
        try {
          sha = await githubGetFileSha(owner, repo, branch, path, token);
          console.log('SHA:', sha);
        } catch (shaError) {
          console.log('تعذر الحصول على SHA، ملف جديد سيتم إنشاؤه:', shaError);
        }
        
        setStatus('رفع التحديث عبر GitHub API (قد يستغرق ثواني)...', 'blue');
        console.log('بدء رفع الملف...');
        
        const res = await githubPutFile(owner, repo, branch, path, utf8ToBase64(newJson), `Add tender ${item.id}`, sha, token);
        console.log('نتيجة الرفع:', res);
        const commitUrl = (res && res.commit && res.commit.html_url) ? res.commit.html_url : '';
        const fileUrl = (res && res.content && res.content.html_url) ? res.content.html_url : '';
        
        setStatus('تم النشر بنجاح إلى GitHub ✔ — قد يستغرق تفعيل GitHub Pages دقيقة.' + (commitUrl ? ` (رابط الـ Commit: ${commitUrl})` : ''), 'green');
        
        console.log('تم النشر بنجاح!', {
          commitUrl,
          fileUrl,
          response: res
        });
        
        try { localStorage.removeItem('itech_tenders_cache'); } catch {}
        
        alert('تم النشر بنجاح ✔\n\nالمناقصة متاحة الآن على الموقع!' + (commitUrl ? '\n\nرابط التأكيد: ' + commitUrl : ''));
        
        // تفريغ الحقول لإضافة مناقصة جديدة
        try {
          const ids = ['f_id','f_title','f_entity','f_city','f_adNumber','f_deadline','f_postedDate','f_status','f_link','f_description','f_documentPrice','f_currency','f_pickupLocation','f_submissionPlace','f_requirements','f_notes','f_phone','f_email'];
          ids.forEach(i => { const el = document.getElementById(i); if (el) el.value = ''; });
          const cat = document.getElementById('f_category'); if (cat) cat.selectedIndex = 0;
        } catch {}
        
        // إعادة تحميل الجدول أسفل الصفحة
        try { 
          console.log('إعادة تحميل القائمة...');
          await renderAdminList(); 
        } catch (listError) {
          console.log('خطأ في إعادة تحميل القائمة:', listError);
        }
        
      } catch (e){
        console.error('خطأ في النشر:', e);
        const msg = 'فشل النشر إلى GitHub: ' + (e && e.message ? e.message : String(e));
        setStatus(msg, 'red');
        alert('حدث خطأ في النشر:\n\n' + msg + '\n\nيرجى التحقق من:\n- صحة GitHub Token\n- أن لديك صلاحيات كتابة للمستودع\n- الاتصال بالإنترنت');
      } finally {
        elPublishGh.disabled = false;
      }
    });

    // زر اختبار الاتصال
    const elTestConnection = $('#btnTestConnection');
    if (elTestConnection) elTestConnection.addEventListener('click', async () => {
      const statusEl = $('#publishStatus');
      function setStatus(msg, color){ 
        if (statusEl) { 
          statusEl.textContent = msg; 
          statusEl.style.color = color || 'var(--text-muted)';
          statusEl.style.display = 'block';
          statusEl.style.padding = '10px';
          statusEl.style.border = '1px solid ' + (color || '#ddd');
          statusEl.style.borderRadius = '5px';
          statusEl.style.backgroundColor = color === 'green' ? '#d4edda' : color === 'red' ? '#f8d7da' : '#d1ecf1';
        }
      }
      
      elTestConnection.disabled = true;
      setStatus('جاري اختبار الاتصال...', 'blue');
      
      try {
        const owner = ($('#gh_owner').value||'').trim();
        const repo = ($('#gh_repo').value||'').trim();
        const token = ($('#gh_token').value||'').trim();
        
        if (!owner || !repo || !token) {
          setStatus('خطأ: يرجى ملء Owner, Repo, و Token', 'red');
          return;
        }
        
        // اختبار الوصول للمستودع
        const repoUrl = `https://api.github.com/repos/${encodeURIComponent(owner)}/${encodeURIComponent(repo)}`;
        const response = await fetch(repoUrl, {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Accept': 'application/vnd.github+json',
            'User-Agent': 'I.TECH-Admin/1.0'
          }
        });
        
        if (response.ok) {
          const repoInfo = await response.json();
          setStatus(`✅ الاتصال ناجح! المستودع: ${repoInfo.full_name} - ${repoInfo.private ? 'خاص' : 'عام'}`, 'green');
          
          // اختبار الصلاحيات
          const permissions = repoInfo.permissions;
          if (permissions && !permissions.push) {
            setStatus('⚠️ تحذير: قد لا تمتلك صلاحية الكتابة في هذا المستودع', 'orange');
          }
        } else if (response.status === 401) {
          setStatus('❌ فشل التوثيق: Token غير صحيح أو منتهي الصلاحية', 'red');
        } else if (response.status === 403) {
          setStatus('❌ ممنوع: لا توجد صلاحية للوصول لهذا المستودع', 'red');
        } else if (response.status === 404) {
          setStatus('❌ المستودع غير موجود أو لا يمكن الوصول إليه', 'red');
        } else {
          const errorText = await response.text();
          setStatus(`❌ خطأ ${response.status}: ${errorText}`, 'red');
        }
        
      } catch (error) {
        console.error('خطأ في اختبار الاتصال:', error);
        setStatus('❌ فشل الاختبار: ' + error.message, 'red');
      } finally {
        elTestConnection.disabled = false;
      }
    });

    const status = document.getElementById('publishStatus');
    if (status) { status.textContent = 'جاهز للنشر عبر GitHub API. أدخل إعدادات GitHub ثم اضغط نشر.'; status.style.color = 'green'; }

    // قسم إدارة العناصر (قائمة مع تحرير/حذف)
    async function renderAdminList(){
      const owner = ($('#gh_owner').value||'').trim();
      const repo = ($('#gh_repo').value||'').trim();
      const branch = ($('#gh_branch').value||'main').trim();
      const path = ($('#gh_path').value||'assets/data/tenders.json').trim();
      const token = ($('#gh_token').value||'').trim();
      const wrap = document.getElementById('adminList');
      if (!wrap) return;
      if (!owner || !repo || !branch || !path) {
        wrap.innerHTML = '<div class="muted">أكمل إعدادات GitHub (المالك، المستودع، الفرع، والمسار) يسار الصفحة، ثم اضغط "تحديث القائمة".</div>';
        return;
      }
      wrap.innerHTML = '<div class="muted">جلب القائمة...</div>';
      try {
        const arr = await fetchCurrentTendersRaw(owner, repo, branch, path);
        const rawUrl = `https://raw.githubusercontent.com/${owner}/${repo}/${encodeURIComponent(branch)}/${path}`;
        if (!Array.isArray(arr) || arr.length === 0) {
          wrap.innerHTML = '<div class="muted">لا توجد عناصر حالياً. تحقق من المسار داخل المستودع — غالباً: <strong>assets/data/tenders.json</strong>.<br>رابط التحقق المباشر: <a href="'+rawUrl+'" target="_blank" rel="noopener">'+rawUrl+'</a></div>';
          return;
        }
        const table = document.createElement('table');
        table.className = 'table';
        table.style.width = '100%';
        table.innerHTML = '<thead><tr><th>رقم</th><th>العنوان</th><th>التصنيف</th><th>مدينة</th><th>إجراءات</th></tr></thead><tbody></tbody>';
        const tbody = table.querySelector('tbody');
        arr.forEach(item => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${item.id||''}</td><td>${item.title||''}</td><td>${item.category||''}</td><td>${item.city||''}</td><td><button class="btn" data-act="edit">تحرير</button> <button class="btn" data-act="del">حذف</button></td>`;
          tr.querySelector('[data-act="edit"]').addEventListener('click', () => {
            try {
              $('#f_id').value = item.id||'';
              $('#f_title').value = item.title||'';
              $('#f_entity').value = item.entity||'';
              $('#f_category').value = item.category||'حكومية';
              $('#f_city').value = item.city||'';
              $('#f_adNumber').value = item.adNumber||'';
              $('#f_deadline').value = item.deadline||'';
              $('#f_postedDate').value = item.postedDate||'';
              $('#f_status').value = item.status||'مفتوح';
              $('#f_link').value = item.link||'';
              $('#f_description').value = item.description||'';
              $('#f_documentPrice').value = item.documentPrice!=null ? String(item.documentPrice) : '';
              $('#f_currency').value = item.currency||'IQD';
              $('#f_pickupLocation').value = item.pickupLocation||'';
              $('#f_submissionPlace').value = item.submissionPlace||'';
              $('#f_requirements').value = Array.isArray(item.submissionRequirements) ? item.submissionRequirements.join('; ') : '';
              $('#f_notes').value = item.notes||'';
              $('#f_phone').value = item.contact && item.contact.phone || '';
              $('#f_email').value = item.contact && item.contact.email || '';
              alert('تم تحميل البيانات في النموذج. عدّل ثم اضغط نشر.');
            } catch {}
          });
          tr.querySelector('[data-act="del"]').addEventListener('click', async () => {
            if (!confirm('تأكيد الحذف؟ سيتم تحديث الملف على GitHub.')) return;
            try {
              const list = await fetchCurrentTendersRaw(owner, repo, branch, path);
              const next = Array.isArray(list) ? list.filter(x => String(x.id||'') !== String(item.id||'')) : [];
              const newJson = JSON.stringify(next, null, 2) + '\n';
              const sha = await githubGetFileSha(owner, repo, branch, path, token);
              await githubPutFile(owner, repo, branch, path, utf8ToBase64(newJson), `Delete tender ${item.id}`, sha, token);
              try { localStorage.removeItem('itech_tenders_cache'); } catch {}
              alert('تم حذف المناقصة ✔');
              await renderAdminList();
            } catch (e) {
              alert('فشل الحذف: ' + (e && e.message ? e.message : String(e)));
            }
          });
          tbody.appendChild(tr);
        });
        wrap.innerHTML = '';
        wrap.appendChild(table);
      } catch (e) {
        wrap.innerHTML = '<div class="muted">تعذر جلب القائمة: '+(e && e.message ? e.message : String(e))+'</div>';
      }
    }

    // زر تحديث القائمة إن وُجد
    const btnRefresh = document.getElementById('btnRefreshList');
    if (btnRefresh) btnRefresh.addEventListener('click', renderAdminList);
    // زر لمسح كاش المناقصات للعرض الفوري في صفحة المناقصات
    const cacheBtn = document.getElementById('btnClearTendersCache');
    if (cacheBtn) cacheBtn.addEventListener('click', () => { try { localStorage.removeItem('itech_tenders_cache'); alert('تم مسح الكاش ✔ افتح صفحة المناقصات بـ ?nocache=1 لقراءة أحدث نسخة.'); } catch {} });
    // محاولة أولية لعرض القائمة عند فتح الصفحة إذا كانت إعدادات GitHub مكتملة
    try {
      const owner = ($('#gh_owner').value||'').trim();
      const repo = ($('#gh_repo').value||'').trim();
      const path = ($('#gh_path').value||'').trim();
      if (owner && repo && path) renderAdminList();
    } catch {}
  }
  if (document.readyState === 'loading') {
    window.addEventListener('DOMContentLoaded', initAdminPage);
  } else {
    // DOM already loaded
    initAdminPage();
  }
  </script>
</body>
</html>
