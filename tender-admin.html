<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>إضافة مناقصة | I.TECH</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="preload" as="style" onload="this.rel='stylesheet'">
  <noscript><link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet"></noscript>
  <link rel="stylesheet" href="./css/main.css" />
</head>
<body class="page-controll">
  <header class="nav">
    <div class="brand">
      <div class="logo-circle"><img src="./assets/images/I-Tech logo.png" alt="I.TECH"/></div>
      <div class="names"><div class="ar">ايتك</div><div class="en">I.TECH</div></div>
    </div>
    <nav class="menu" aria-label="التنقل">
      <a href="index.html">الرئيسية</a>
      <a href="tenders.html">مناقصات العراق</a>
    </nav>
    <button class="burger" aria-label="فتح القائمة" aria-expanded="false">☰</button>
  </header>

  <main class="container">
    <section class="card" id="adminArea">
      <h1>إضافة مناقصة جديدة</h1>
      <p>املأ الحقول ثم اضغط "نشر على GitHub" لتحديث الملف JSON ضمن الموقع مباشرة (بدون Backend). البيانات تظهر في صفحة "مناقصات العراق" فور تحديث الملف.</p>
      <div class="grid-2">
        <div>
          <div class="form">
            <label>رقم المناقصة (id)</label>
            <input id="f_id" placeholder="مثال: 2025-006"/>
            <label>العنوان</label>
            <input id="f_title"/>
            <label>الجهة</label>
            <input id="f_entity"/>
            <label>التصنيف</label>
            <select id="f_category">
              <option>حكومية</option>
              <option>شركات</option>
              <option>جامعات</option>
              <option>منظمات</option>
            </select>
            <label>المدينة</label>
            <input id="f_city"/>
            <label>رقم الإعلان</label>
            <input id="f_adNumber"/>
            <label>تاريخ النشر</label>
            <input id="f_postedDate" type="date"/>
            <label>الموعد النهائي</label>
            <input id="f_deadline" type="date"/>
            <label>الحالة</label>
            <input id="f_status" placeholder="مفتوح"/>
            <label>رابط المصدر</label>
            <input id="f_link" placeholder="#"/>
            <label>الوصف</label>
            <textarea id="f_description" rows="4"></textarea>
            <label>سعر الكراس</label>
            <input id="f_documentPrice" type="number"/>
            <label>العملة</label>
            <input id="f_currency" value="IQD"/>
            <label>مكان استلام الكراس</label>
            <input id="f_pickupLocation"/>
            <label>مكان التقديم</label>
            <input id="f_submissionPlace"/>
            <label>متطلبات التقديم (افصل بـ ;)</label>
            <textarea id="f_requirements" rows="3" placeholder="هوية الضريبة; كتاب عدم ممانعة"></textarea>
            <label>ملاحظات</label>
            <textarea id="f_notes" rows="2"></textarea>
            <label>هاتف الاتصال</label>
            <input id="f_phone"/>
            <label>البريد الإلكتروني</label>
            <input id="f_email"/>
            <div id="publishStatus" style="margin-top:10px;color:var(--text-muted);"></div>

            <hr style="margin:18px 0; opacity:.3;">
            <h2 style="margin:6px 0 10px;">نشر مباشر على GitHub Pages (بدون Backend)</h2>
            <p class="muted">هذه الطريقة تُجري تعديلًا مباشرًا على الملف <strong>assets/data/tenders.json</strong> داخل مستودع GitHub عبر واجهة GitHub API. تتطلب رمز وصول شخصي (PAT) مع صلاحية <strong>contents:write</strong> لهذا المستودع. لا تشارك الرمز علنًا.</p>
            <div class="form">
              <label>GitHub Owner</label>
              <input id="gh_owner" placeholder="مثال: abubesun-hub"/>
              <label>GitHub Repo</label>
              <input id="gh_repo" placeholder="مثال: I.tech"/>
              <label>Branch</label>
              <input id="gh_branch" value="main"/>
              <label>Path داخل المستودع</label>
              <input id="gh_path" value="assets/data/tenders.json"/>
              <label>GitHub Token (PAT)</label>
              <input id="gh_token" type="password" placeholder="ghp_xxx أو fine-grained token"/>
              <div style="display:flex;align-items:center;gap:10px;margin-top:8px;">
                <label style="display:flex;align-items:center;gap:6px;">
                  <input type="checkbox" id="gh_remember_token"/>
                  حفظ الرمز محليًا على هذا المتصفح (اختياري)
                </label>
              </div>
              <div class="actions" style="margin-top:12px;">
                <button class="btn primary" id="btnPublishGithub">نشر مباشر على صفحة المناقصات (GitHub)</button>
              </div>
            </div>
          </div>
        </div>
        <div></div>
      </div>
    </section>
  </main>

  <script>
  // Ensure initialization runs whether DOMContentLoaded has fired or not
  function initAdminPage(){

    const $ = (id)=>document.getElementById(id);
    // تهيئة بسيطة
    function buildItem(){
      const reqs = ($('#f_requirements').value||'').split(';').map(s=>s.trim()).filter(Boolean);
      return {
        id: $('#f_id').value || ('TMP-' + Date.now()),
        title: $('#f_title').value,
        entity: $('#f_entity').value,
        category: $('#f_category').value,
        city: $('#f_city').value,
        adNumber: $('#f_adNumber').value,
        deadline: $('#f_deadline').value,
        postedDate: $('#f_postedDate').value,
        status: $('#f_status').value || 'مفتوح',
        link: $('#f_link').value || '#',
        description: $('#f_description').value,
        documentPrice: parseInt($('#f_documentPrice').value||'0',10),
        currency: $('#f_currency').value || 'IQD',
        pickupLocation: $('#f_pickupLocation').value,
        submissionPlace: $('#f_submissionPlace').value,
        submissionRequirements: reqs,
        notes: $('#f_notes').value,
        files: [],
        contact: { phone: $('#f_phone').value, email: $('#f_email').value }
      };
    }
    // لا حاجة لتوليد CSV/تنزيلات؛ النشر يتم عبر GitHub API مباشرة

    // ---- النشر المباشر إلى GitHub (تعديل الملف داخل المستودع) ----
    // Helpers
    function utf8ToBase64(str){
      try { return btoa(unescape(encodeURIComponent(str))); } catch(e){ return btoa(str); }
    }
    async function githubGetFileSha(owner, repo, branch, path, token){
      const url = `https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}?ref=${encodeURIComponent(branch)}`;
      const r = await fetch(url, { headers: { 'Accept':'application/vnd.github+json', 'Authorization': token ? `Bearer ${token}` : '' } });
      if (r.status === 404) return null; // file not found
      if (!r.ok) throw new Error('GitHub API (get sha) failed: '+r.status);
      const j = await r.json();
      return j && j.sha ? j.sha : null;
    }
    async function githubPutFile(owner, repo, branch, path, contentBase64, message, shaOrNull, token){
      const url = `https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}`;
      const body = { message, content: contentBase64, branch };
      if (shaOrNull) body.sha = shaOrNull;
      const r = await fetch(url, { method:'PUT', headers: { 'Accept':'application/vnd.github+json', 'Content-Type':'application/json', 'Authorization': token ? `Bearer ${token}` : '' }, body: JSON.stringify(body) });
      if (!r.ok) {
        const t = await r.text().catch(()=> '');
        throw new Error('GitHub API (put file) failed: '+r.status+' '+t);
      }
      return await r.json();
    }
    async function fetchCurrentTendersRaw(owner, repo, branch, path){
      const rawUrl = `https://raw.githubusercontent.com/${owner}/${repo}/${encodeURIComponent(branch)}/${path}`;
      const r = await fetch(rawUrl);
      if (r.status === 404) return [];
      if (!r.ok) throw new Error('Fetch raw failed: '+r.status);
      try { return await r.json(); } catch { return []; }
    }

    // Prefill from LocalStorage
    try {
      const owner = localStorage.getItem('itech_gh_owner'); if (owner) $('#gh_owner').value = owner;
      const repo = localStorage.getItem('itech_gh_repo'); if (repo) $('#gh_repo').value = repo;
      const branch = localStorage.getItem('itech_gh_branch'); if (branch) $('#gh_branch').value = branch;
      const path = localStorage.getItem('itech_gh_path'); if (path) $('#gh_path').value = path;
      const savedTok = localStorage.getItem('itech_gh_token'); if (savedTok) { $('#gh_token').value = savedTok; $('#gh_remember_token').checked = true; }
    } catch {}

    const elPublishGh = $('#btnPublishGithub');
    if (elPublishGh) elPublishGh.addEventListener('click', async ()=>{
      const statusEl = $('#publishStatus');
      function setStatus(msg, color){ if (statusEl) { statusEl.textContent = msg; statusEl.style.color = color || 'var(--text-muted)'; } }
      // visual feedback immediately
      setStatus('بدء عملية النشر إلى GitHub...', 'var(--text-muted)');
      elPublishGh.disabled = true;
      try {
        const owner = ($('#gh_owner').value||'').trim();
        const repo = ($('#gh_repo').value||'').trim();
        const branch = ($('#gh_branch').value||'main').trim();
        const path = ($('#gh_path').value||'assets/data/tenders.json').trim();
        const token = ($('#gh_token').value||'').trim();
        if (!owner || !repo || !branch || !path || !token) { alert('أكمل حقول GitHub وادخل الرمز (PAT).'); return; }

        // persist preferences
        try {
          localStorage.setItem('itech_gh_owner', owner);
          localStorage.setItem('itech_gh_repo', repo);
          localStorage.setItem('itech_gh_branch', branch);
          localStorage.setItem('itech_gh_path', path);
          const remember = $('#gh_remember_token').checked; if (remember) localStorage.setItem('itech_gh_token', token); else localStorage.removeItem('itech_gh_token');
        } catch {}

        setStatus('جلب الملف الحالي من GitHub...', 'var(--text-muted)');
        const arr = await fetchCurrentTendersRaw(owner, repo, branch, path);
        const item = buildItem();
        // منع تكرار id إن وجد
        const exists = Array.isArray(arr) && arr.some(x => String(x.id||'') === String(item.id||''));
        if (exists) {
          if (!confirm('يوجد عنصر بنفس رقم المناقصة. متابعة واستبدال القديم؟')) return;
          for (let i=0;i<arr.length;i++){ if (String(arr[i].id||'') === String(item.id||'')) { arr[i] = item; break; } }
        } else {
          arr.push(item);
        }

        const newJson = JSON.stringify(arr, null, 2) + '\n';
        setStatus('الحصول على SHA للملف من GitHub...', 'var(--text-muted)');
        const sha = await githubGetFileSha(owner, repo, branch, path, token);
        setStatus('رفع التحديث عبر GitHub API (قد يستغرق ثواني)...', 'var(--text-muted)');
        const res = await githubPutFile(owner, repo, branch, path, utf8ToBase64(newJson), `Add tender ${item.id}`, sha, token);
        setStatus('تم النشر بنجاح إلى GitHub ✔ — قد يستغرق تفعيل GitHub Pages دقيقة.', 'green');
      } catch (e){
        setStatus('فشل النشر إلى GitHub: ' + (e && e.message ? e.message : String(e)), 'red');
      } finally {
        elPublishGh.disabled = false;
      }
    });

    const status = document.getElementById('publishStatus');
    if (status) { status.textContent = 'جاهز للنشر عبر GitHub API. أدخل إعدادات GitHub ثم اضغط نشر.'; status.style.color = 'green'; }
  }
  if (document.readyState === 'loading') {
    window.addEventListener('DOMContentLoaded', initAdminPage);
  } else {
    // DOM already loaded
    initAdminPage();
  }
  </script>
</body>
</html>
