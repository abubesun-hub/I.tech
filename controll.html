<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>لوحة التحكم | I.TECH</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="preload" as="style" onload="this.rel='stylesheet'">
  <noscript><link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet"></noscript>
  <link rel="stylesheet" href="./css/main.css" />
  <link rel="icon" type="image/png" href="./assets/images/I-Tech logo.png" />
</head>
<body class="page-controll">
  <div id="login-overlay" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(248,250,252,0.98);z-index:9999;display:flex;align-items:center;justify-content:center;flex-direction:column;">
    <div class="card" style="max-width:400px;width:90%;text-align:center;padding:40px;">
      <div style="margin-bottom:20px;">
        <img src="./assets/images/I-Tech logo.png" alt="Logo" style="width:80px;height:80px;">
      </div>
      <h2 style="margin-bottom:24px;">تسجيل دخول المسؤول</h2>
      <div class="form">
        <input type="text" id="admin-user" placeholder="اسم المستخدم" style="margin-bottom:12px;text-align:center;">
        <input type="password" id="admin-pass" placeholder="كلمة المرور" style="margin-bottom:16px;text-align:center;">
        <button class="btn primary" id="btn-login" style="width:100%;">دخول</button>
        <p id="login-error" style="color:#ef4444;display:none;margin-top:12px;font-weight:bold;">فشل تسجيل الدخول</p>
      </div>
    </div>
  </div>
  <script>
    // ملاحظة أمنية: لا يمكن إخفاء كلمات المرور في ملفات الواجهة الأمامية.
    // الحل: التحقق يتم من جهة خادم (Web App) ويعيد رمز وصول (Token).
    const LOGIN_URL = window.ITECH_LOGIN_URL || 'https://script.google.com/macros/s/AKfycbxJL5THQR4YfjSYehmozhTeEkmUFmv70cJLJljVOxh3A7xqj7HIOJljPbn-MtxFPGybGA/exec'; // اضبطه إلى رابط النشر من Google Apps Script
    const elOverlay = document.getElementById('login-overlay');
    const elErr = document.getElementById('login-error');
    const elBtn = document.getElementById('btn-login');
    async function doLogin(){
      elErr.style.display = 'none';
      const u = (document.getElementById('admin-user').value||'').trim();
      const p = (document.getElementById('admin-pass').value||'').trim();
      if(!LOGIN_URL || LOGIN_URL.includes('YOUR_APPS_SCRIPT_WEBAPP_URL')){
        elErr.textContent = 'خدمة تسجيل الدخول غير مُعدة. الرجاء تهيئة رابط الخادم.';
        elErr.style.display = 'block';
        return;
      }
      try {
        elBtn.disabled = true;
        const url = `${LOGIN_URL}?action=login&user=${encodeURIComponent(u)}&pass=${encodeURIComponent(p)}`;
        const r = await fetch(url, { method: 'GET', credentials: 'omit' });
        const j = await r.json();
        if(j && j.ok && j.token){
          sessionStorage.setItem('itech_token', j.token);
          elOverlay.style.opacity = '0';
          setTimeout(()=>{ elOverlay.style.display = 'none'; }, 300);
        } else {
          elErr.textContent = 'بيانات الدخول غير صحيحة';
          elErr.style.display = 'block';
        }
      } catch(e){
        elErr.textContent = 'تعذر الاتصال بالخادم';
        elErr.style.display = 'block';
      } finally {
        elBtn.disabled = false;
      }
    }
    document.getElementById('btn-login').addEventListener('click', doLogin);
  </script>
  <header class="nav">
    <div class="brand">
      <div class="logo-circle">
        <img src="./assets/images/I-Tech logo.png" alt="شعار ايتك I.TECH" />
      </div>
      <div class="names">
        <div class="ar">ايتك</div>
        <div class="en">I.TECH</div>
      </div>
    </div>
    <nav class="menu">
      <a href="index.html">الرئيسية</a>
      <a href="tenders-new.html">مناقصات العراق</a>
      <a href="about.html">من نحن</a>
      <a href="services.html">الخدمات</a>
      <a href="contact.html">تواصل معنا</a>
      <a href="add-tender.html" class="pill">إضافة مناقصة</a>
    </nav>
    <button class="burger" aria-label="فتح القائمة" aria-expanded="false">☰</button>
  </header>
  

  <main class="container">
    <section class="card">
      <h1>إحصائيات فورية (نسخة تجريبية)</h1>
      <div class="grid-3">
        <div class="stat card"><div class="label">زيارات اليوم</div><div id="visitsToday" class="value">0</div></div>
        <div class="stat card"><div class="label">إجمالي الزيارات</div><div id="visitsTotal" class="value">0</div></div>
        <div class="stat card"><div class="label">طلبات التواصل</div><div id="contacts" class="value">0</div></div>
      </div>
      <p class="muted">هذه نسخة أولية بدون خادم. تُخزَّن الأرقام محلياً في المتصفح.</p>
    </section>

    <!-- إدخال البرامج: داخل لوحة التحكم -->
    <section class="card" id="programAdmin">
      <h1>إضافة برنامج جديد</h1>
      <p>املأ بيانات البرنامج ثم اضغط "نشر على GitHub" ليُحدّث الملف <strong>assets/data/programs.json</strong> مباشرة ويظهر في صفحة "البرامج".</p>
      <div class="grid-2">
        <div>
          <div class="form">
            <label>اسم البرنامج</label>
            <input id="p_name" placeholder="مثال: نظام المخزون" />
            <label>معلومات عن البرنامج</label>
            <textarea id="p_desc" rows="3" placeholder="وصف موجز"></textarea>
            <label>رابط لوغو البرنامج</label>
            <input id="p_logo" placeholder="https://..." />
            <label>الصورة الرئيسية</label>
            <input id="p_image" placeholder="https://..." />
            <label>سعر البرنامج</label>
            <input id="p_price" type="number" placeholder="مثال: 250" />
            <label>العملة (اختياري)</label>
            <input id="p_currency" value="IQD" />
            <input id="p_id" type="hidden" />

            <hr style="margin:14px 0; opacity:.3;">
            <h2 style="margin:6px 0 10px;">صور إضافية (حتى 10 روابط)</h2>
            <div class="grid-2">
              <input id="p_img1" placeholder="https://..." />
              <input id="p_img2" placeholder="https://..." />
              <input id="p_img3" placeholder="https://..." />
              <input id="p_img4" placeholder="https://..." />
              <input id="p_img5" placeholder="https://..." />
              <input id="p_img6" placeholder="https://..." />
              <input id="p_img7" placeholder="https://..." />
              <input id="p_img8" placeholder="https://..." />
              <input id="p_img9" placeholder="https://..." />
              <input id="p_img10" placeholder="https://..." />
            </div>

            <h2 style="margin:14px 0 10px;">روابط فيديو (حتى 2)</h2>
            <div class="grid-2">
              <input id="p_vid1" placeholder="https://..." />
              <input id="p_vid2" placeholder="https://..." />
            </div>

            <div id="programPublishStatus" style="margin-top:15px;padding:12px;border-radius:5px;display:none;font-weight:600;"></div>

            <hr style="margin:18px 0; opacity:.3;">
            <h2 style="margin:6px 0 10px;">نشر مباشر على GitHub</h2>
            <p class="muted">يتطلب رمز وصول شخصي (PAT) بصلاحية contents:write للمستودع.
              سيتم تعديل الملف <strong>assets/data/programs.json</strong> مباشرة عبر GitHub API.
            </p>
            <div class="form">
              <label>GitHub Owner</label>
              <input id="pg_owner" placeholder="مثال: abubesun-hub" />
              <label>GitHub Repo</label>
              <input id="pg_repo" placeholder="مثال: I.tech" />
              <label>Branch</label>
              <input id="pg_branch" value="main" />
              <label>Path داخل المستودع</label>
              <input id="pg_path" value="assets/data/programs.json" />
              <label>GitHub Token (PAT)</label>
              <input id="pg_token" type="password" placeholder="ghp_xxx" />
              <div style="display:flex;align-items:center;gap:10px;margin-top:8px;">
                <label style="display:flex;align-items:center;gap:6px;">
                  <input type="checkbox" id="pg_remember_token" />
                  حفظ الرمز محليًا (اختياري)
                </label>
              </div>
              <div class="actions" style="margin-top:12px;">
                <button class="btn primary" id="btnPublishProgram">نشر على GitHub</button>
                <button class="btn" id="btnTestPgConnection" style="margin-right:10px;">اختبار الاتصال</button>
              </div>
            </div>
          </div>
        </div>
        <div>
          <h2>البرامج الحالية</h2>
          <div class="actions" style="margin-bottom:8px;">
            <button class="btn" id="btnRefreshPrograms">تحديث القائمة</button>
            <button class="btn" id="btnClearProgramsCache">مسح كاش البرامج</button>
          </div>
          <div id="programsAdminList" class="card" style="padding:12px;"></div>
        </div>
      </div>
    </section>
  </main>

  <footer class="footer">
    <div class="social">
      <a href="https://www.instagram.com/i.tech02/" target="_blank" rel="noopener" aria-label="Instagram">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="20" rx="5"/><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"/><line x1="17.5" y1="6.5" x2="17.51" y2="6.5"/></svg>
      </a>
        <a href="https://www.facebook.com/I.tech025/" target="_blank" rel="noopener" aria-label="Facebook">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M22 12a10 10 0 1 0-11.6 9.9v-7h-2.5V12h2.5V9.8c0-2.5 1.5-3.9 3.8-3.9 1.1 0 2.3.2 2.3.2v2.5h-1.3c-1.3 0-1.7.8-1.7 1.6V12h2.9l-.5 2.9h-2.4v7A10 10 0 0 0 22 12z"/></svg>
      </a>
      <a href="https://www.linkedin.com/in/itech-anbar/" target="_blank" rel="noopener" aria-label="LinkedIn">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M4.98 3.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5zM3 8.98h4v12H3v-12zM9 8.98h3.8v1.64h.05c.53-1 1.82-2.06 3.75-2.06 4 0 4.74 2.63 4.74 6.06v6.36h-4v-5.64c0-1.35-.02-3.09-1.88-3.09-1.88 0-2.17 1.47-2.17 3v5.73H9v-12z"/></svg>
      </a>
      <a href="https://www.tiktok.com/@user79508805600398" target="_blank" rel="noopener" aria-label="TikTok">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M17.5 6.1c1.2 1 2.7 1.6 4.3 1.7v3.1c-1.6 0-3.2-.4-4.6-1.2v5.8c0 3.7-3 6.5-6.7 6.5S3.8 19.2 3.8 15.5c0-3.7 3-6.7 6.7-6.7.5 0 1 .1 1.5.2v3.3c-.5-.2-1-.3-1.5-.3-2 0-3.6 1.6-3.6 3.6s1.6 3.5 3.6 3.5 3.6-1.6 3.6-3.6V2h3.4c.2 1.5 1 2.9 2.5 4.1z"/></svg>
      </a>
      <a href="https://www.youtube.com/@I.tech025" target="_blank" rel="noopener" aria-label="YouTube">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M23.5 6.2a3 3 0 0 0-2.1-2.1C19.4 3.5 12 3.5 12 3.5s-7.4 0-9.4.6A3 3 0 0 0 .5 6.2C0 8.2 0 12 0 12s0 3.8.5 5.8a3 3 0 0 0 2.1 2.1c2 .6 9.4 .6 9.4 .6s7.4 0 9.4-.6a3 3 0 0 0 2.1-2.1c.5-2 .5-5.8 .5-5.8s0-3.8-.5-5.8zM9.5 15.5v-7l6 3.5-6 3.5z"/></svg>
      </a>
      <a href="https://wa.me/9647817823680" target="_blank" rel="noopener" aria-label="WhatsApp">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M20 3.9A10 10 0 0 0 3.3 18.1L2 22l4-1.3A10 10 0 1 0 20 3.9zM12 4a8 8 0 0 1 0 16h-.1a8 8 0 0 1-4.2-1.2l-.3-.2-2.5.8.8-2.4-.2-.3A8 8 0 0 1 12 4zm4.5 9.7c-.2-.1-1.3-.6-1.5-.7-.2-.1-.3-.1-.5.1-.1.2-.6.7-.7.8-.1.1-.2.1-.4 0-.2-.1-.9-.3-1.7-1-.6-.5-1-1.2-1.1-1.4-.1-.2 0-.3.1-.4l.3-.3c.1-.1.1-.2.2-.3.1-.1.1-.2 0-.4-.1-.2-.5-1.2-.7-1.6-.2-.4-.4-.3-.5-.3h-.4c-.1 0-.4.1-.6.3-.2.2-.8.8-.8 1.9s.8 2.1.9 2.2c.1.1 1.6 2.5 3.9 3.4.5.2.9.3 1.2.4.5.2 1 .2 1.3.1.4-.1 1.3-.5 1.5-1 .2-.5.2-.9.1-1 0-.2-.1-.2-.3-.3z"/></svg>
      </a>
      <a href="tel:+9647817823680" aria-label="Phone">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M6.6 10.2c1.6 3.1 4.1 5.6 7.2 7.2l2.4-2.4c.4-.4 1-.5 1.5-.3 1 .3 2 .5 3 .6 .6 .1 1 .6 1 1.2v3.1c0 .7-.6 1.3-1.3 1.3C9.3 21 3 14.7 3 6.3 3 5.6 3.6 5 4.3 5h3.1c.6 0 1.1 .4 1.2 1 .1 1 .3 2 .6 3 .1 .5 0 1.1-.4 1.5l-2.2 2.7z"/></svg>
      </a>
      <a href="mailto:itechanbar@gmail.com" aria-label="Email">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2zm0 2v.01L12 12l8-6.01V6H4zm16 12V8.5l-8 6-8-6V18ه16z"/></svg>
      </a>
    </div>
    <small>© 2025 I.TECH</small>
  </footer>

  <script src="./js/main.js" defer></script>
  <script>
    // --- Helpers (مشابهة لإدارة المناقصات) ---
    function utf8ToBase64(str){ try { return btoa(unescape(encodeURIComponent(str))); } catch(e){ return btoa(str); } }
    function encodePathSegments(p){ try { return (p||'').split('/').map(encodeURIComponent).join('/'); } catch { return p; } }
    async function githubGetFileSha(owner, repo, branch, path, token){
      const url = `https://api.github.com/repos/${encodeURIComponent(owner)}/${encodeURIComponent(repo)}/contents/${encodePathSegments(path)}?ref=${encodeURIComponent(branch)}`;
      const headers = { 'Accept':'application/vnd.github+json','Authorization':`Bearer ${token}`,'User-Agent':'I.TECH-Admin/1.0' };
      const r = await fetch(url, { headers });
      if (r.status === 404) return null; if (!r.ok) throw new Error('GitHub API (get sha) failed: '+r.status+' - '+await r.text());
      const j = await r.json(); return j && j.sha ? j.sha : null;
    }
    async function githubPutFile(owner, repo, branch, path, contentBase64, message, shaOrNull, token){
      const url = `https://api.github.com/repos/${encodeURIComponent(owner)}/${encodeURIComponent(repo)}/contents/${encodePathSegments(path)}`;
      const body = { message, content: contentBase64, branch }; if (shaOrNull) body.sha = shaOrNull;
      const headers = { 'Accept':'application/vnd.github+json','Content-Type':'application/json','Authorization':`Bearer ${token}`,'User-Agent':'I.TECH-Admin/1.0' };
      const r = await fetch(url, { method:'PUT', headers, body: JSON.stringify(body) });
      if (!r.ok) throw new Error('GitHub API error '+r.status+': '+await r.text());
      return await r.json();
    }
    async function fetchCurrentProgramsRaw(owner, repo, branch, path){
      const rawUrl = `https://raw.githubusercontent.com/${owner}/${repo}/${encodeURIComponent(branch)}/${path}`;
      const r = await fetch(rawUrl, { cache:'no-store', headers:{ 'Accept':'application/json' } });
      if (r.status === 404) return []; if (!r.ok) throw new Error('Fetch raw failed: '+r.status);
      try { return await r.json(); } catch { return []; }
    }

    // Prefill GitHub fields from LocalStorage
    (function(){
      try {
        const owner = localStorage.getItem('itech_pg_owner'); if (owner) document.getElementById('pg_owner').value = owner;
        const repo = localStorage.getItem('itech_pg_repo'); if (repo) document.getElementById('pg_repo').value = repo;
        const branch = localStorage.getItem('itech_pg_branch'); if (branch) document.getElementById('pg_branch').value = branch;
        const path = localStorage.getItem('itech_pg_path'); if (path) document.getElementById('pg_path').value = path;
        const tok = localStorage.getItem('itech_pg_token'); if (tok) { document.getElementById('pg_token').value = tok; document.getElementById('pg_remember_token').checked = true; }
      } catch {}
    })();

    function setPgStatus(msg, color){
      const statusEl = document.getElementById('programPublishStatus');
      if (!statusEl) return; statusEl.textContent = msg; statusEl.style.color = color || 'var(--text-muted)';
      statusEl.style.display = 'block'; statusEl.style.padding = '10px';
      statusEl.style.border = '1px solid ' + (color || '#ddd'); statusEl.style.borderRadius = '5px';
      statusEl.style.backgroundColor = color === 'green' ? '#d4edda' : color === 'red' ? '#f8d7da' : '#d1ecf1';
    }

    function buildProgramItem(){
      const name = (document.getElementById('p_name').value||'').trim();
      const desc = (document.getElementById('p_desc').value||'').trim();
      const logo = (document.getElementById('p_logo').value||'').trim();
      const image = (document.getElementById('p_image').value||'').trim();
      const price = (document.getElementById('p_price').value||'').trim();
      const currency = (document.getElementById('p_currency').value||'IQD').trim();
      const imgs = [];
      for(let i=1;i<=10;i++){ const v = (document.getElementById('p_img'+i).value||'').trim(); if (v) imgs.push(v); }
      const vids = [];
      for(let i=1;i<=2;i++){ const v = (document.getElementById('p_vid'+i).value||'').trim(); if (v) vids.push(v); }
      const existingId = (document.getElementById('p_id').value||'').trim();
      const id = existingId || ((name ? name.replace(/\s+/g,'-').toLowerCase() : 'program') + '-' + Date.now());
      return {
        id,
        name,
        logo,
        image,
        shortDescription: desc,
        price: price ? Number(price) : undefined,
        currency,
        images: imgs,
        videos: vids,
        link: '#'
      };
    }

    async function renderProgramsAdminList(){
      const owner = (document.getElementById('pg_owner').value||'').trim();
      const repo = (document.getElementById('pg_repo').value||'').trim();
      const branch = (document.getElementById('pg_branch').value||'main').trim();
      const path = (document.getElementById('pg_path').value||'assets/data/programs.json').trim();
      const wrap = document.getElementById('programsAdminList');
      if (!wrap) return;
      if (!owner || !repo || !branch || !path){ wrap.innerHTML = '<div class="muted">أكمل إعدادات GitHub ثم اضغط "تحديث القائمة".</div>'; return; }
      wrap.innerHTML = '<div class="muted">جلب القائمة...</div>';
      try {
        const arr = await fetchCurrentProgramsRaw(owner, repo, branch, path);
        const rawUrl = `https://raw.githubusercontent.com/${owner}/${repo}/${encodeURIComponent(branch)}/${path}`;
        if (!Array.isArray(arr) || arr.length === 0){ wrap.innerHTML = '<div class="muted">لا توجد برامج حالياً.<br>رابط التحقق: <a href="'+rawUrl+'" target="_blank" rel="noopener">'+rawUrl+'</a></div>'; return; }
        const table = document.createElement('table'); table.className='table'; table.style.width='100%';
        table.innerHTML = '<thead><tr><th>الاسم</th><th>السعر</th><th>صور</th><th>إجراءات</th></tr></thead><tbody></tbody>';
        const tbody = table.querySelector('tbody');
        arr.forEach(item=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${item.name||''}</td><td>${item.price!=null?item.price+(item.currency?' '+item.currency:''):''}</td><td>${Array.isArray(item.images)?item.images.length:0}</td><td><button class="btn" data-act="edit">تحرير</button> <button class="btn" data-act="del">حذف</button></td>`;
          tr.querySelector('[data-act="edit"]').addEventListener('click', ()=>{
            try {
              document.getElementById('p_id').value = item.id||'';
              document.getElementById('p_name').value = item.name||'';
              document.getElementById('p_desc').value = item.shortDescription||'';
              document.getElementById('p_logo').value = item.logo||'';
              document.getElementById('p_image').value = item.image||'';
              document.getElementById('p_price').value = item.price!=null?String(item.price):'';
              document.getElementById('p_currency').value = item.currency||'IQD';
              // fill images/videos
              for(let i=1;i<=10;i++){
                const val = (Array.isArray(item.images) && item.images[i-1]) ? item.images[i-1] : '';
                const el = document.getElementById('p_img'+i); if (el) el.value = val||'';
              }
              for(let i=1;i<=2;i++){
                const val = (Array.isArray(item.videos) && item.videos[i-1]) ? item.videos[i-1] : '';
                const el = document.getElementById('p_vid'+i); if (el) el.value = val||'';
              }
              setPgStatus('تم تحميل بيانات البرنامج في النموذج. عدّل ثم اضغط نشر.', 'blue');
            } catch(e){ setPgStatus('تعذر تحميل بيانات التحرير: '+(e&&e.message?e.message:String(e)), 'red'); }
          });
          tr.querySelector('[data-act="del"]').addEventListener('click', async ()=>{
            if (!confirm('تأكيد حذف البرنامج؟ سيتم تحديث الملف على GitHub.')) return;
            try {
              const owner = (document.getElementById('pg_owner').value||'').trim();
              const repo = (document.getElementById('pg_repo').value||'').trim();
              const branch = (document.getElementById('pg_branch').value||'main').trim();
              const path = (document.getElementById('pg_path').value||'assets/data/programs.json').trim();
              const token = (document.getElementById('pg_token').value||'').trim();
              if (!owner||!repo||!branch||!path||!token){ setPgStatus('أكمل إعدادات GitHub أولاً', 'red'); return; }
              const list = await fetchCurrentProgramsRaw(owner, repo, branch, path);
              const next = Array.isArray(list) ? list.filter(x => String(x.id||'') !== String(item.id||'')) : [];
              const newJson = JSON.stringify(next, null, 2) + '\n';
              const sha = await githubGetFileSha(owner, repo, branch, path, token);
              const res = await githubPutFile(owner, repo, branch, path, utf8ToBase64(newJson), `Delete program ${item.id}`, sha, token);
              setPgStatus('تم حذف البرنامج ✔' + (res && res.commit && res.commit.html_url ? ` — ${res.commit.html_url}` : ''), 'green');
              try { localStorage.removeItem('itech_programs_cache'); } catch {}
              await renderProgramsAdminList();
            } catch(e){ setPgStatus('فشل الحذف: '+(e&&e.message?e.message:String(e)), 'red'); }
          });
          tbody.appendChild(tr);
        });
        wrap.innerHTML=''; wrap.appendChild(table);
      } catch (e){ wrap.innerHTML = '<div class="muted">تعذر جلب القائمة: '+(e&&e.message?e.message:String(e))+'</div>'; }
    }

    document.getElementById('btnRefreshPrograms').addEventListener('click', renderProgramsAdminList);
    document.getElementById('btnClearProgramsCache').addEventListener('click', () => { try { localStorage.removeItem('itech_programs_cache'); alert('تم مسح كاش البرامج ✔ افتح صفحة البرامج بـ ?nocache=1 لقراءة أحدث نسخة.'); } catch {} });

    document.getElementById('btnTestPgConnection').addEventListener('click', async ()=>{
      setPgStatus('جاري اختبار الاتصال...', 'blue');
      try {
        const owner = (document.getElementById('pg_owner').value||'').trim();
        const repo = (document.getElementById('pg_repo').value||'').trim();
        const token = (document.getElementById('pg_token').value||'').trim();
        if (!owner || !repo || !token){ setPgStatus('يرجى ملء Owner, Repo, و Token', 'red'); return; }
        const repoUrl = `https://api.github.com/repos/${encodeURIComponent(owner)}/${encodeURIComponent(repo)}`;
        const response = await fetch(repoUrl, { headers: { 'Authorization':`Bearer ${token}`,'Accept':'application/vnd.github+json','User-Agent':'I.TECH-Admin/1.0' } });
        if (response.ok){ const info = await response.json(); setPgStatus(`✅ الاتصال ناجح: ${info.full_name}`, 'green'); }
        else if (response.status===401){ setPgStatus('❌ Token غير صحيح أو منتهي', 'red'); }
        else if (response.status===403){ setPgStatus('❌ لا توجد صلاحية للوصول/الكتابة', 'red'); }
        else { setPgStatus('❌ خطأ '+response.status+': '+await response.text(), 'red'); }
      } catch (e){ setPgStatus('❌ فشل الاختبار: '+(e&&e.message?e.message:String(e)), 'red'); }
    });

    document.getElementById('btnPublishProgram').addEventListener('click', async ()=>{
      setPgStatus('بدء النشر إلى GitHub...', 'blue');
      const name = (document.getElementById('p_name').value||'').trim();
      if (!name){ setPgStatus('يرجى إدخال اسم البرنامج', 'red'); alert('اسم البرنامج مطلوب'); return; }
      const item = buildProgramItem();
      const owner = (document.getElementById('pg_owner').value||'').trim();
      const repo = (document.getElementById('pg_repo').value||'').trim();
      const branch = (document.getElementById('pg_branch').value||'main').trim();
      const path = (document.getElementById('pg_path').value||'assets/data/programs.json').trim();
      const token = (document.getElementById('pg_token').value||'').trim();
      if (!owner || !repo || !branch || !path || !token){ setPgStatus('أكمل إعدادات GitHub والرمز (PAT)', 'red'); alert('أكمل إعدادات GitHub والرمز'); return; }
      try {
        // remember preferences
        try {
          localStorage.setItem('itech_pg_owner', owner);
          localStorage.setItem('itech_pg_repo', repo);
          localStorage.setItem('itech_pg_branch', branch);
          localStorage.setItem('itech_pg_path', path);
          const remember = document.getElementById('pg_remember_token').checked; if (remember) localStorage.setItem('itech_pg_token', token); else localStorage.removeItem('itech_pg_token');
        } catch {}

        // fetch current
        setPgStatus('جلب الملف الحالي...', 'blue');
        let arr = [];
        try { arr = await fetchCurrentProgramsRaw(owner, repo, branch, path); } catch { arr = []; }
        // add or update item by id
        const idx = Array.isArray(arr) ? arr.findIndex(x => String(x.id||'') === String(item.id||'')) : -1;
        if (idx >= 0) {
          arr[idx] = item;
          setPgStatus('سيتم تحديث البرنامج الموجود...', 'orange');
        } else {
          arr.push(item);
        }
        const newJson = JSON.stringify(arr, null, 2) + '\n';

        // get sha and publish
        setPgStatus('الحصول على SHA...', 'blue');
        let sha = null; try { sha = await githubGetFileSha(owner, repo, branch, path, token); } catch { sha = null; }
        setPgStatus('رفع التحديث إلى GitHub...', 'blue');
        const res = await githubPutFile(owner, repo, branch, path, utf8ToBase64(newJson), `${idx>=0?'Update':'Add'} program ${item.id}`, sha, token);
        const commitUrl = (res && res.commit && res.commit.html_url) ? res.commit.html_url : '';
        const fileUrl = (res && res.content && res.content.html_url) ? res.content.html_url : '';
        setPgStatus('تم النشر بنجاح ✔' + (commitUrl ? ` — رابط التأكيد: ${commitUrl}` : ''), 'green');
        try { localStorage.removeItem('itech_programs_cache'); } catch {}
        alert('تم نشر البرنامج بنجاح ✔\nسيظهر في صفحة البرامج بعد تحديث GitHub Pages.' + (commitUrl ? '\n\nرابط الـ Commit: '+commitUrl : ''));

        // clear fields
        try {
          ['p_name','p_desc','p_logo','p_image','p_price','p_currency','p_vid1','p_vid2','p_id'].forEach(id=>{ const el=document.getElementById(id); if (el) el.value=''; });
          for(let i=1;i<=10;i++){ const el=document.getElementById('p_img'+i); if (el) el.value=''; }
        } catch {}

        // refresh admin list
        try { await renderProgramsAdminList(); } catch {}
      } catch (e){ setPgStatus('فشل النشر: '+(e&&e.message?e.message:String(e)), 'red'); alert('خطأ: '+(e&&e.message?e.message:String(e))); }
    });

    // auto-render if fields prefilled
    try {
      const owner = (document.getElementById('pg_owner').value||'').trim();
      const repo = (document.getElementById('pg_repo').value||'').trim();
      const path = (document.getElementById('pg_path').value||'').trim();
      if (owner && repo && path) renderProgramsAdminList();
    } catch {}
  </script>
</body>
</html>
